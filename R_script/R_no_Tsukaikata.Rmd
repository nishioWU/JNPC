---
title: "R and RStudio"
author: "yoshito.nishio+JNPC@gmail.com"
date: "2018/9/22"
output:
  html_document: default
  pdf_document: default
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# RとRStudioの使い方

### Rって何？

「R」は統計処理に強いプログラム言語で、フリーソフト。  
素のままでは取っつきにくいので、使い勝手をよくする「RStudio」上で使うことを、強くお勧めする。
また、今からRを始める方は、Rのもともとの関数よりもさまざまな点で優れている、「tidyverse」というパッケージソフトを使うとよい。一貫性があるので、覚えやすい。
右上の「＋」ボタンで「R Script」を選んで新規作成するとエディターペインが開くので、そこにコードを書いていく。小さなまとまりごとに実行してみて、辛抱強くエラーを取り除きながら……。なお、RはExcelとは違って、大文字と小文字を区別することに注意。RStudioには補完機能があるので、入力の途中でTabを押すと、候補を表示してくれる。  

### Rを使うメリット

裏を返せば、Excelのデメリット。  
Rはデータと処理が分離されている。食材とレシピが分離されているイメージ。同じ料理を繰り返し提供できる「再現可能性」が高い。他人が見て、何をしているのかの流れが追いやすいし、点検やメンテナンスがしやすい。  
Excelはデータと処理が渾然一体となっている。料理の完成品だけがあっても、もう一度同じものが作れる保証はない。再現可能性が低く、あとから（何をやったか忘れたころに）手直しするのも大変。  
NICARで講師を務めた The Guardian の記者からは「Rなら、専門家にコードとデータを送って、自分の分析が間違っていないか検証してもらうことができるのが強み。私がRを始めた理由はこれ」と聞いた。  
デメリットは、日本語の扱いがまだ、こなれていないこと。RStudioで日本語を打つのはやりにくいし、後出のプロジェクト名に日本語を使うのは避けた方がよいらしい。また、Macの場合はプロットの文字化け対策に一手間かかる。  
きょうは、デフォルトでは不可視設定の「.Rprofile」というファイルに、極力文字化けを防ぐ設定を入れている。また、全員で同じデータを読む都合上、「JNPC-master」というプロジェクト（本日用の環境設定）で、文字コードは「UTF-8」に決め打ちしている。  

### RStudioの画面構成

田んぼの「田」みたいなペイン。左下（エディターを使っていないときは左半分全部）がRの実行画面で、コンソールという。左上は、Rのコードを書いて保存するためのエディター。右上は今使っている変数のリストや履歴など。右下はプロットが出力されたり、ヘルプが開いたり。  
基本は、右上の画面でRのコードを書き、「Ctrl + Enter」でカーソルのある行またはブロックの命令を実行（右下のコンソールに送られる）。全体を実行するなら、上の「Run」から「Run All」を選ぶ。  

### パッケージのインストール

素のままのRに入っていない、オプションのものを使うときには、「パッケージのインストール」と「読み込み」が必要。インストールは最初に１度だけすればよいが、読み込みはRを起動するたびにしなくてはならない。  
きょうも使う２つのパッケージで練習してみる。  
なお、#から後は、プログラムとしては実行されない、コメントになる。将来の自分のために、まめに説明を残しておくとよい。あるいは、今は使わないけれど、必要になるかもしれない命令を、消さないで取っておくためにコメントにすることは、よくある。実行するときは、#を消す。「Shift + Control + C」で、コメントになったり、元に戻ったり、切り替わる。  

```{r install_and_require}
# 最初の１回だけ、この下２行の「#」を削って「install.packages」を実行して。２回目からは不要

# install.packages("tidyverse")
# install.packages("GGally")

# この下の２行は、このパッケージを使うなら、Rを起動するたびに実行して。requireの代わりにlibraryでもいい。
require(tidyverse)
require(GGally)
```

うまく行っただろうか？　「××が見つかりません」という類のエラーメッセージが出た方は、お知らせを。見つからない、と言われたパッケージをインストールすると、解決することが多い。

### スカラー、ベクトル、データフレーム
Rは、データの塊を一括処理するのが得意。Excelで言えば、セル１つに当たるものを個別に扱うだけでなく、１列まとめてや、シート１枚丸ごとに同じ処理を適用することができる。最後の縦横２次元になったデータの組を、データフレームとRでは呼んでいる。  

```{r first_step}
# データの入れ物を変数という
# 数字を１つ入れてみる
hensuu0 <- 12345
# 右向き矢印が代入。「Altとマイナスの同時押し」で出る。MacではAltではなく「option」
# 他のプログラム言語のように、イコールでも代入できる。ちなみに「等しい」はイコール２つ（==）で表す

# 中身を見るには、変数名を入力すればよい
hensuu0

# c()はベクトルを作る命令。combineの意
hensuu1 <- c(1, 2, 3, 4, 5)
hensuu1

# hensuu1のすべての要素に、hensuu0を足す
hensuu1 + hensuu0

# * はかけ算の記号
hensuu1 * hensuu1
# ５つの数がそれぞれ２乗された

# データフレームの例
hensuu2 <- data.frame(hensuu1, hensuu1 * 2, hensuu1 * 2)
hensuu2

# 列に項目名をつけるなら
hensuu2 <- data.frame(first = hensuu1, second = hensuu1 * 2, third = hensuu1 * 3)
hensuu2
```

head()とtail()でデータの先頭部分と末尾部分だけを見られる。  
RStudioのビューアーで、Excelのシートのように見るには、View(hensuu2)のようにする。Vは大文字。  

列を取り出すなら、$の後に項目名をつける。とりあえず、このやり方だけ覚えておく  

```{r first_step2}
hensuu2$second

# 数字で指定することもできる。１列目と３列目（すべての行）
hensuu2[ , c(1, 3)]

# ３行目から５行目の、firstとthird列
hensuu2[3:5, c("first", "third")]
```

### プロジェクト

まず「プロジェクト」というものを作ってから、作業に取りかかるとよい。一連の分析に関するもの一式をディレクトリーにまとめ、それを管理する仕組み。左上の２番目の「＋」ボタンで作れる。既存のディレクトリーでも、新規作成してもよい。  
きょうは、このファイルも入っている「R_script」というディレクトリーに、プロジェクトを設定しておいた。  
今の作業場所がどこかは、getwd()で、今の作業場所がどこか調べられる。データを読み込むときのパスは、ここを基準にして指定する。同じ階層のdataフォルダのものなら、「../data/ファイル名」。最初の「..」で１階層上の「JNPC-master」に上がって、「data」フォルダに降りている。  

### ファイルの読み込み

read_csv()を使う。ドットではなく、アンダースコア。tidyverseパッケージを呼び込んでいないと使えない。  
ファイルのパスを指定する。もし、CP932の文字コードのファイルを読むなら、その指定「, locale = locale(encoding = 'CP932')」をつける。パスを指定せずに、ダイアログで選ぶ方法もある。これはよく使う。

```{r handling_data_files}
climate18 <- read_csv("../data/climate18.csv")
head(climate18)

# S-JISで読み込むなら、以下のようにエンコードを指定
cafe_sjis <- read_csv("../data/cafe_data_sjis.csv", locale = locale(encoding = 'CP932'))
head(cafe_sjis)
tail(cafe_sjis)

# ダイアログボックスが開くので、どれでもよいからCSV形式のファイルを選んでみて
# suki_na_CSV <- read_csv(file.choose())
# head(suki_na_CSV)
```

### 相関係数

cor()を使う。かっこ内は(X列のデータ,Y列のデータ)。

```{r cor}
# まず、全国計は抜いておく。都道府県の列の値が「合計」である行は不要、という指示。!=は等しくない、の意味
cafe_sjis <- cafe_sjis[cafe_sjis$都道府県 != "合計", ]
# ２列だけ取り出して、相関係数を計算した
cor(cafe_sjis$人口, cafe_sjis$世帯数)
# 数値の列だけを取り出して、cafeという新しいデータフレームに保存した。tidyverseの命令を使っている
# どれとどれの相関が強いか、まとめて見てみる。対角線を挟んで右上と左下は同じ
cafe <- cafe_sjis %>%
  select(人口, 世帯数, スタバ, ドトール, コメダ)
cor(cafe)
```

こういった処理結果を、変数に代入して保存しておくことができる。あとでさらに加工するときなどに、よく使う。  

### 散布図

その前に、散布図を見ておくべきなのだった。見栄えにこだわらないなら、plot()でいい。これもXとY、または、もっとたくさん指定できる。  

```{r}
# XとYを指定した
plot(cafe_sjis$人口, cafe_sjis$世帯数)
# 数値データをまとめて渡した
plot(cafe)
```

数値でないものが入るとエラーする。  

### ggplot2

見栄えがよいのは、「ggplot2」パッケージを使う方法。いったん変数に保存する方法でやってみる。丁寧に書いているが、「data = 」と「mapping = 」は、慣れてきたら入力しなくてもよい。  

```{r ggplot2}
star_doutor <- ggplot(
  data = cafe,
  mapping = aes(x = スタバ, y = ドトール)
) + geom_point()
# それを表示
star_doutor
```

Macでは文字化けしているのでは？　その対策を１行追加し、書き方は簡略化した。  

```{r for_Mac}
old = theme_set(theme_gray(base_family="HiraKakuProN-W3")) # この１行はWindowsでは不要
star_doutor <- ggplot(cafe, aes(x = スタバ, y = ドトール)) +
  geom_point()
star_doutor
```

画像の保存にもハードルがある。とりあえず、画像をクリックするか、右下のプロットペインから「Download Image」か「Export」を選ぶ。  

２項目だけでなく、たくさんの項目について、一度に見たいときは、GGallyパッケージの「ggpairs」を使う。少し時間がかかる。  

```{r ggpairs, message=FALSE}
ggpairs(cafe)
```

### 回帰直線

lm()を使う。linear modelの意。中には「フォーミュラ」と呼ばれる式を書く。

```{r lm, message=FALSE}
# 人口と世帯の２列だけにする
cafe2 <- cafe_sjis %>%
  select(人口, 世帯数)
# 単回帰分析をする
cafe_lm <- lm(世帯数 ~ 人口, cafe2)
cafe_lm
# 散布図に回帰直線を重ねる
plot(cafe2)
abline(cafe_lm)
```

```{r lm_ggplot2, message=FALSE}
ggplot(cafe, aes(x = 人口, y = 世帯数)) +
  geom_point() +
  geom_smooth(method = lm, se = FALSE)

```

ggplot2の場合、回帰直線を追加で引くだけなら、「+ geom_smooth()」を加えればよい。ただし、いろいろな近似直線をひく機能があるので、「method = lm, se = FALSE」を指定して、線形近似で標準誤差表示なし、にする。  
係数を知るには、やはりlm()で。  

### 資料
ショートカットキーの一覧を別ファイルに。  
上のメニュー欄の「Help」から「Cheatsheets」→「RStudio IDE Cheat Sheet」とたどると、表裏１枚のアンチョコがある。  
Rはネットに先達の情報が豊富にあるが、入門に向いているのは、三重大の奥村晴彦先生のサイト
[「Rの初歩」](https://oku.edu.mie-u.ac.jp/~okumura/stat/first.html)
。データの可視化によく使う「ggplot2」については、総研大の岩嵜航さんのスライド
[「Rにやらせて楽ラクしよう ーー データの可視化と下ごしらえ」](https://heavywatal.github.io/slides/nagoya2018/2-ggplot.html)
がとても参考になる。前後の回も、ぜひ。  
